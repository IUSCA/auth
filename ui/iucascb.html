<!DOCTYPE html>
<html ng-app="iucascb">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
</head>
<body ng-cloak>
    <script src="bower_components/angular/angular.min.js"></script>
    <script src="bower_components/angular-jwt/dist/angular-jwt.min.js"></script>
    <script src="bower_components/angular-cookies/angular-cookies.min.js"></script>

    <script src="config.js"></script>
    <script>
    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    var app = angular.module('iucascb', ['app.config', 'ngCookies']);
    app.run(['$http', 'appconf', '$cookies', function($http, appconf, $cookies) {
        console.log("(run) in iucascb");
        var casticket = getParameterByName('casticket');
        $http.get(appconf.api+'/iucas/verify?casticket='+casticket)
        .success(function(data, status, headers, config) {
            console.log("verify success");
            console.dir(data);
            if(data.jwt) {
                localStorage.setItem(appconf.jwt_id, data.jwt);
            }
            if(data.need_setpass) {
                document.location = './#/setpass';
            } else {
                //TODO - this is pretty much just a duplicate of js/app.js redirector.. how can I refactor it?
                var redirect = localStorage.getItem('post_auth_redirect');
                if(redirect) {
                    console.log("redirecting to "+redirect);
                    localStorage.removeItem('post_auth_redirect');
                } else {
                    console.log("post_auth_redirect not set.. using default_redirect_url:"+appconf.default_redirect_url);
                    //$location.path("/user")
                    redirect = appconf.default_redirect_url;
                }
                window.location = redirect;
            }
        })
        .error(function(data, status, headers, config) {
            //console.log("failed");
            //console.dir(data);
            var messages = [{
                type: 'error',
                title: 'Failed to verify IU CAS Ticket',
                message: data.msg
            }];
            $cookies.put('messages', JSON.stringify(messages), {path: '/'});
            document.location = './';  //move to index page
        }); 
    }]);
    </script>

</body>
</html>

