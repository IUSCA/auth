<!DOCTYPE html>
<html ng-app="iucascb">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
</head>
<body ng-cloak>
    <script src="bower_components/angular/angular.min.js"></script>
    <script src="bower_components/angular-jwt/dist/angular-jwt.min.js"></script>
    <script src="bower_components/angular-cookies/angular-cookies.min.js"></script>

    <script src="config.js"></script>
    <script>

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    //if user has jwt, send to server so that iucas account will be associated to the user account
    var app = angular.module('iucascb', ['app.config', 'ngCookies', 'angular-jwt']);
    app.config(['appconf', '$httpProvider', 'jwtInterceptorProvider', 
    function(appconf, $httpProvider, jwtInterceptorProvider) {
        jwtInterceptorProvider.tokenGetter = function(jwtHelper, config, $http) {
            return localStorage.getItem(appconf.jwt_id);
        }
        $httpProvider.interceptors.push('jwtInterceptor');
    }]);

    app.run(['$http', 'appconf', '$cookies', function($http, appconf, $cookies) {
        //console.log("(run) in iucascb");
        var casticket = getParameterByName('casticket');
        $http.get(appconf.api+'/iucas/verify?casticket='+casticket)
        .success(function(data, status, headers, config) {
            //console.log("verify success");
            //console.dir(data);
            if(data.jwt) {
                localStorage.setItem(appconf.jwt_id, data.jwt);
            }
            if(data.need_setpass) {
                document.location = './#/setpass';
            } else {
                //TODO - this is pretty much just a duplicate of js/app.js redirector.. how can I refactor it?
                /*
                var redirect = localStorage.getItem('post_auth_redirect');
                if(redirect) {
                    localStorage.removeItem('post_auth_redirect');
                } else {
                    redirect = appconf.default_redirect_url;
                }
                */
                var redirect = localStorage.getItem('post_auth_redirect');
                if(redirect[0] == '#') redirect = './'+redirect; //try /auth/# instead of /auth/iucascb.html/#
                document.location = redirect;
            }
        })
        .error(function(data, status, headers, config) {
            console.log("token verification failed");
            console.dir(data);
            var messages = [{
                type: 'error',
                title: 'Failed to verify IU CAS Ticket',
                message: data.msg
            }];
            $cookies.put('messages', JSON.stringify(messages), {path: '/'});
            document.location = './';  //move to index page
        }); 
    }]);
    </script>

</body>
</html>

